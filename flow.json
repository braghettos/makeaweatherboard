[{"id":"9596c410.fe1e08","type":"tab","label":"Call 5 day / 3 hour forecast data","disabled":false,"info":""},{"id":"26c5c0d8.cd22a","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"ba7d881.25dde78","type":"subflow","name":"Convert weather icon to sun_cloud_rain_snow","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"835c173e.97ed08"}]}],"out":[{"x":820,"y":180,"wires":[{"id":"1ef66f8c.ff9cc","port":0},{"id":"c6780eb7.ddf99","port":0},{"id":"94a2ee98.c524b","port":0},{"id":"7f8e165b.2a3058","port":0},{"id":"35b661be.00237e","port":0},{"id":"142b90bd.1358ff","port":0},{"id":"cc6fcfdc.17ec5","port":0},{"id":"68b13ebf.06c9","port":0}]}],"env":[],"color":"#DDAA99","icon":"font-awesome/fa-cloud"},{"id":"29e98dcf.49cdd2","type":"subflow","name":"Convert hour and icon to Rpi pin","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"6b513b66.bebee4"},{"id":"19655eea.93d561"}]}],"out":[{"x":1400,"y":440,"wires":[{"id":"6d347571.79125c","port":0},{"id":"c25bc947.c65638","port":0},{"id":"df15f705.6356e8","port":0},{"id":"564a83e2.2ee8dc","port":0},{"id":"6d58371.7408cc8","port":0},{"id":"e2fb0047.7921f","port":0},{"id":"d977767a.d99748","port":0},{"id":"853b3f7d.e96e2","port":0},{"id":"4cf37f41.57a81","port":0},{"id":"548e01ed.e5bfe","port":0},{"id":"1995b804.b7ff48","port":0},{"id":"ed8d5d41.3ff6e","port":0},{"id":"ac8a10c4.5b80a","port":0},{"id":"f5c5d2b6.28068","port":0},{"id":"af6a4dec.9bdbb","port":0},{"id":"cb65f723.c92408","port":0},{"id":"8e1166f3.8921d8","port":0},{"id":"2b1e9fcf.93cf2","port":0},{"id":"1481105f.8a03d","port":0}]}],"env":[],"icon":"node-red/rpi.png"},{"id":"fd9e96f3.fb83a8","type":"subflow","name":"Global light based on sunrise and sunset","info":"","category":"","in":[],"out":[{"x":640,"y":140,"wires":[{"id":"b76aba3d.09d068","port":0},{"id":"c8cbd44.c78be28","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"53bb66ef.614bd8","type":"inject","z":"9596c410.fe1e08","name":"make request","topic":"","payload":"","payloadType":"date","repeat":"3600","crontab":"","once":false,"onceDelay":"","x":140,"y":100,"wires":[["2cee0ce5.8d9154"]]},{"id":"2cee0ce5.8d9154","type":"http request","z":"9596c410.fe1e08","name":"WeatherResponse","method":"GET","ret":"obj","paytoqs":false,"url":"api.openweathermap.org/data/2.5/forecast?q=Milan,IT&units=metric&APPID=d076045f4ebbf2b7eb16aac16bb056ab","tls":"","proxy":"","x":334.5,"y":100,"wires":[["1d1302c5.6f9bcd","d95f640c.71a608"]]},{"id":"1d1302c5.6f9bcd","type":"debug","z":"9596c410.fe1e08","name":"WeatherResponse debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":650,"y":100,"wires":[]},{"id":"239ce825.a06108","type":"split","z":"9596c410.fe1e08","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":510,"y":400,"wires":[["b1bf7bb4.63d9e8","1076ca3f.1c60f6"]]},{"id":"48296aee.051514","type":"change","z":"9596c410.fe1e08","name":"Set msg.payload from list","rules":[{"t":"move","p":"payload.list","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":280,"wires":[["239ce825.a06108","a649bec0.195c4"]]},{"id":"b1bf7bb4.63d9e8","type":"debug","z":"9596c410.fe1e08","name":"split debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":750,"y":400,"wires":[]},{"id":"a649bec0.195c4","type":"debug","z":"9596c410.fe1e08","name":"Set msg.payload from list","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":790,"y":280,"wires":[]},{"id":"613f50ee.31fd1","type":"switch","z":"9596c410.fe1e08","name":"Switch by same day","property":"dt.day","propertyType":"msg","rules":[{"t":"eq","v":"dt_now.day","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":786,"y":520,"wires":[["8f329690.f90428","8b620f78.fe4f1"],["e039bce0.59e26","433f776b.a73bf8"]]},{"id":"8f329690.f90428","type":"debug","z":"9596c410.fe1e08","name":"same day debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1030,"y":480,"wires":[]},{"id":"805230dd.3eb0d","type":"debug","z":"9596c410.fe1e08","name":"hour debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":616,"y":620,"wires":[]},{"id":"1076ca3f.1c60f6","type":"function","z":"9596c410.fe1e08","name":"timeConvert","func":"//node.warn(\"dt=\" + (msg.payload.dt*1000));\n\nif ( !(msg.payload.dt) ) msg.payload.dt = Math.round(+new Date());\n\n//node.warn(\"dt=\" + (msg.payload.dt*1000));\n\nvar dt = new Date(msg.payload.dt*1000);\n\nvar dt_now = new Date();\n\nvar newmsg = {'dt': {\n\t'month':\tdt.getMonth() + 1,\n\t'day':\t\tdt.getDate(),\n\t'year':\t\tdt.getFullYear(),\n\t'hours':\tdt.getHours(),\n\t'mins':\t\tdt.getMinutes(),\n\t'msecs':\tdt.getMilliseconds(),\n\t'payload' : msg.payload\n},\n'dt_now':\n{\n\t'month':\tdt_now.getMonth() + 1,\n\t'day':\t\tdt_now.getDate(),\n\t'nextday':\tdt_now.getDate() + 1,\n\t'year':\t\tdt_now.getFullYear(),\n\t'hours':\tdt_now.getHours(),\n\t'mins':\t\tdt_now.getMinutes(),\n\t'msecs':\tdt_now.getMilliseconds()\n}\n}\n\n//node.warn(\"dt.day=\" + newmsg.dt.day + \",dt_now.day=\" + newmsg.dt_now.day );\n\nreturn newmsg;","outputs":1,"noerr":0,"x":556,"y":520,"wires":[["613f50ee.31fd1","805230dd.3eb0d"]]},{"id":"e039bce0.59e26","type":"debug","z":"9596c410.fe1e08","name":"different day debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1030,"y":540,"wires":[]},{"id":"9622accd.45216","type":"switch","z":"9596c410.fe1e08","name":"Switch by 23 hour","property":"dt.hours","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1250,"y":640,"wires":[["abf253bc.26ff2","a054730c.eddb6"]]},{"id":"abf253bc.26ff2","type":"debug","z":"9596c410.fe1e08","name":"23 hour debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1340,"y":580,"wires":[]},{"id":"2e16dd62.552472","type":"function","z":"9596c410.fe1e08","name":"Weather at 08:00","func":"var newmsg = msg;\nnewmsg.hour = 8;\n//newmsg.trigger = 1;\n\nreturn newmsg;","outputs":1,"noerr":0,"x":1610,"y":460,"wires":[["929053d2.7c3a","72d4b0f2.7bf1e"]]},{"id":"fdd00fcd.c9364","type":"function","z":"9596c410.fe1e08","name":"Weather at 14:00","func":"var newmsg = msg;\nnewmsg.hour = 14;\n//newmsg.trigger = 1;\n\nreturn newmsg;","outputs":1,"noerr":0,"x":1610,"y":620,"wires":[["a57de72f.ce3f78","7f9cc189.4dea1"]]},{"id":"dbc37810.2fc348","type":"function","z":"9596c410.fe1e08","name":"Weather at 20:00","func":"var newmsg = msg;\nnewmsg.hour = 20;\n//newmsg.trigger = 1;\n\nreturn newmsg;","outputs":1,"noerr":0,"x":1610,"y":780,"wires":[["47f4e0e0.eaaaa","78f57064.80725"]]},{"id":"a054730c.eddb6","type":"function","z":"9596c410.fe1e08","name":"Weather at 23:00","func":"var newmsg = msg;\nnewmsg.hour = 23;\n//newmsg.trigger = 1;\n\nreturn newmsg;","outputs":1,"noerr":0,"x":1610,"y":940,"wires":[["5ba55d72.fcb274","bc726170.fa8d6"]]},{"id":"929053d2.7c3a","type":"debug","z":"9596c410.fe1e08","name":"Weather at 08:00 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1870,"y":460,"wires":[]},{"id":"a57de72f.ce3f78","type":"debug","z":"9596c410.fe1e08","name":"Weather at 14:00 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1870,"y":620,"wires":[]},{"id":"47f4e0e0.eaaaa","type":"debug","z":"9596c410.fe1e08","name":"Weather at 20:00 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1858,"y":780,"wires":[]},{"id":"5ba55d72.fcb274","type":"debug","z":"9596c410.fe1e08","name":"Weather at 23:00 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1858,"y":940,"wires":[]},{"id":"835c173e.97ed08","type":"switch","z":"ba7d881.25dde78","name":"","property":"dt.payload.weather[0].id","propertyType":"msg","rules":[{"t":"btwn","v":"200","vt":"num","v2":"232","v2t":"num"},{"t":"btwn","v":"300","vt":"num","v2":"321","v2t":"num"},{"t":"btwn","v":"500","vt":"num","v2":"531","v2t":"num"},{"t":"btwn","v":"600","vt":"num","v2":"622","v2t":"num"},{"t":"btwn","v":"701","vt":"num","v2":"781","v2t":"num"},{"t":"eq","v":"800","vt":"str"},{"t":"eq","v":"801","vt":"str"},{"t":"btwn","v":"802","vt":"num","v2":"804","v2t":"num"}],"checkall":"true","repair":false,"outputs":8,"x":270,"y":180,"wires":[["1ef66f8c.ff9cc"],["c6780eb7.ddf99"],["94a2ee98.c524b"],["7f8e165b.2a3058"],["35b661be.00237e"],["142b90bd.1358ff"],["cc6fcfdc.17ec5"],["68b13ebf.06c9"]]},{"id":"1ef66f8c.ff9cc","type":"function","z":"ba7d881.25dde78","name":"Group 2xx: Thunderstorm","func":"var newmsg = msg;\nmsg.icon = \"rain\";\nreturn newmsg;","outputs":1,"noerr":0,"x":530,"y":60,"wires":[[]]},{"id":"c6780eb7.ddf99","type":"function","z":"ba7d881.25dde78","name":"Group 3xx: Drizzle","func":"var newmsg = msg;\nmsg.icon = \"rain\";\nreturn newmsg;","outputs":1,"noerr":0,"x":510,"y":100,"wires":[[]]},{"id":"94a2ee98.c524b","type":"function","z":"ba7d881.25dde78","name":"Group 5xx: Rain","func":"var newmsg = msg;\nmsg.icon = \"rain\";\nreturn newmsg;","outputs":1,"noerr":0,"x":500,"y":140,"wires":[[]]},{"id":"7f8e165b.2a3058","type":"function","z":"ba7d881.25dde78","name":"Group 6xx: Snow","func":"var newmsg = msg;\nmsg.icon = \"snow\";\nreturn newmsg;","outputs":1,"noerr":0,"x":510,"y":180,"wires":[[]]},{"id":"35b661be.00237e","type":"function","z":"ba7d881.25dde78","name":"Group 7xx: Atmosphere","func":"var newmsg = msg;\nmsg.icon = \"clouds\";\nreturn newmsg;","outputs":1,"noerr":0,"x":530,"y":220,"wires":[[]]},{"id":"142b90bd.1358ff","type":"function","z":"ba7d881.25dde78","name":"Group 800: Clear","func":"var newmsg = msg;\nmsg.icon = \"sun\";\nreturn newmsg;","outputs":1,"noerr":0,"x":510,"y":260,"wires":[[]]},{"id":"cc6fcfdc.17ec5","type":"function","z":"ba7d881.25dde78","name":"Group 801: Sunclouds","func":"var newmsg = msg;\nmsg.icon = \"sunclouds\";\nreturn newmsg;","outputs":1,"noerr":0,"x":520,"y":300,"wires":[["b99320a5.e529"]]},{"id":"6b513b66.bebee4","type":"switch","z":"29e98dcf.49cdd2","name":"Switch by 8, 14, 20 and 23 hour","property":"hour","propertyType":"msg","rules":[{"t":"eq","v":"8","vt":"num"},{"t":"eq","v":"14","vt":"str"},{"t":"eq","v":"20","vt":"str"},{"t":"eq","v":"23","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":290,"y":420,"wires":[["84b8e847.87e608","9333823f.a043e"],["3d7a83a5.e8d41c","9333823f.a043e"],["9f058c4d.f070f","9333823f.a043e"],["e2e4f59.93f5008","9333823f.a043e"],[]]},{"id":"84b8e847.87e608","type":"switch","z":"29e98dcf.49cdd2","name":"Switch by sun, clouds, rain, snow ad sunclouds at 08:00","property":"icon","propertyType":"msg","rules":[{"t":"eq","v":"sun","vt":"str"},{"t":"eq","v":"clouds","vt":"str"},{"t":"eq","v":"rain","vt":"str"},{"t":"eq","v":"snow","vt":"str"},{"t":"eq","v":"sunclouds","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":730,"y":140,"wires":[["6d347571.79125c"],["c25bc947.c65638"],["df15f705.6356e8"],["564a83e2.2ee8dc"],["1481105f.8a03d"]]},{"id":"3d7a83a5.e8d41c","type":"switch","z":"29e98dcf.49cdd2","name":"Switch by sun, clouds, rain, snow and sunclouds at 14:00","property":"icon","propertyType":"msg","rules":[{"t":"eq","v":"sun","vt":"str"},{"t":"eq","v":"clouds","vt":"str"},{"t":"eq","v":"rain","vt":"str"},{"t":"eq","v":"snow","vt":"str"},{"t":"eq","v":"sunclouds","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":730,"y":360,"wires":[["6d58371.7408cc8"],["e2fb0047.7921f"],["d977767a.d99748"],["853b3f7d.e96e2"],["2b1e9fcf.93cf2"]]},{"id":"9f058c4d.f070f","type":"switch","z":"29e98dcf.49cdd2","name":"Switch by sun, clouds, rain, snow and sunclouds at 20:00","property":"icon","propertyType":"msg","rules":[{"t":"eq","v":"sun","vt":"str"},{"t":"eq","v":"clouds","vt":"str"},{"t":"eq","v":"rain","vt":"str"},{"t":"eq","v":"snow","vt":"str"},{"t":"eq","v":"sunclouds","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":730,"y":580,"wires":[["4cf37f41.57a81"],["548e01ed.e5bfe"],["1995b804.b7ff48"],["ed8d5d41.3ff6e"],["8953785e.aaffa8"]]},{"id":"e2e4f59.93f5008","type":"switch","z":"29e98dcf.49cdd2","name":"Switch by sun, cloud, rain, snow and sunclouds at 23:00","property":"icon","propertyType":"msg","rules":[{"t":"eq","v":"sun","vt":"str"},{"t":"eq","v":"clouds","vt":"str"},{"t":"eq","v":"rain","vt":"str"},{"t":"eq","v":"snow","vt":"str"},{"t":"eq","v":"sunclouds","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":730,"y":800,"wires":[["ac8a10c4.5b80a"],["f5c5d2b6.28068"],["af6a4dec.9bdbb"],["cb65f723.c92408"],["8e1166f3.8921d8"]]},{"id":"72d4b0f2.7bf1e","type":"subflow:ba7d881.25dde78","z":"9596c410.fe1e08","name":"","env":[],"x":1900,"y":520,"wires":[["4d01ba43.0753b4","474472e7.09913c"]]},{"id":"4d01ba43.0753b4","type":"debug","z":"9596c410.fe1e08","name":"Convert weather icon at 08:00","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2240,"y":560,"wires":[]},{"id":"b99320a5.e529","type":"debug","z":"ba7d881.25dde78","name":"clouds debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":340,"wires":[]},{"id":"19655eea.93d561","type":"debug","z":"29e98dcf.49cdd2","name":"convert hour debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":280,"y":80,"wires":[]},{"id":"474472e7.09913c","type":"subflow:29e98dcf.49cdd2","z":"9596c410.fe1e08","name":"","env":[],"x":2270,"y":520,"wires":[["e235e4db.3a25d8"]]},{"id":"9333823f.a043e","type":"debug","z":"29e98dcf.49cdd2","name":"Switch by 8, 14, 20 and 23 hour debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":450,"y":240,"wires":[]},{"id":"7f9cc189.4dea1","type":"subflow:ba7d881.25dde78","z":"9596c410.fe1e08","name":"","env":[],"x":1900,"y":680,"wires":[["cf872af0.d97948","deeb04de.028428"]]},{"id":"cf872af0.d97948","type":"debug","z":"9596c410.fe1e08","name":"Convert weather icon at 14:00","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2240,"y":720,"wires":[]},{"id":"deeb04de.028428","type":"subflow:29e98dcf.49cdd2","z":"9596c410.fe1e08","name":"","env":[],"x":2270,"y":680,"wires":[["e235e4db.3a25d8"]]},{"id":"78f57064.80725","type":"subflow:ba7d881.25dde78","z":"9596c410.fe1e08","name":"","env":[],"x":1900,"y":840,"wires":[["2e20379d.91d558","3aaf84d9.bb20fc"]]},{"id":"2e20379d.91d558","type":"debug","z":"9596c410.fe1e08","name":"Convert weather icon at 20:00","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2240,"y":880,"wires":[]},{"id":"3aaf84d9.bb20fc","type":"subflow:29e98dcf.49cdd2","z":"9596c410.fe1e08","name":"","env":[],"x":2270,"y":840,"wires":[["e235e4db.3a25d8"]]},{"id":"bc726170.fa8d6","type":"subflow:ba7d881.25dde78","z":"9596c410.fe1e08","name":"","env":[],"x":1900,"y":1000,"wires":[["cea63698.d67798","f521350f.f59638"]]},{"id":"cea63698.d67798","type":"debug","z":"9596c410.fe1e08","name":"Convert weather icon at 23:00","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2240,"y":1040,"wires":[]},{"id":"f521350f.f59638","type":"subflow:29e98dcf.49cdd2","z":"9596c410.fe1e08","name":"","env":[],"x":2270,"y":1000,"wires":[["e235e4db.3a25d8","e7378d3d.72b5f"]]},{"id":"296f2284.de7aee","type":"function","z":"9596c410.fe1e08","name":"global set icons","func":"var icons = [];\nvar brightness = 16;\nglobal.set('icons',icons);\n//global.set('brightness',brightness);\n\nvar newmsg = msg;\nreturn newmsg;","outputs":1,"noerr":0,"x":236,"y":280,"wires":[["48296aee.051514","631db46f.16a12c"]]},{"id":"631db46f.16a12c","type":"debug","z":"9596c410.fe1e08","name":"global set icons debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":240,"y":360,"wires":[]},{"id":"6d347571.79125c","type":"function","z":"29e98dcf.49cdd2","name":"Sun at 08:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 0,\n             'y': 7\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":80,"wires":[["33f56069.f0cd5"]]},{"id":"c25bc947.c65638","type":"function","z":"29e98dcf.49cdd2","name":"Cloud at 08:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 0,\n             'y': 6\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":120,"wires":[["33f56069.f0cd5"]]},{"id":"5dc4d062.c26c9","type":"function","z":"9596c410.fe1e08","name":"global push icons","func":"var icons = global.get('icons');\n\nnode.warn(\"PRE global icons length=\" + icons.length + \", local icons length=\" + msg.icons.length);\n\nvar i;\nfor (i = 0; i < msg.icons.length; i++) {\n    node.warn(\"x=\" + msg.icons[i].x + \", y=\" + msg.icons[i].y);\n\n    var newmsg = {\n\t'x': msg.icons[i].x,\n\t'y': msg.icons[i].y\n    }\n    \n    icons.push(JSON.stringify(newmsg));\n    node.warn(\"icons print=\" + icons.toString());\n}\n\nnode.warn(\"POST global icons length=\" + icons.length + \", local icons length=\" + msg.icons.length);\n\nglobal.set('icons',icons);\n\nvar msgbck=msg;\nreturn msgbck;","outputs":1,"noerr":0,"x":2850,"y":760,"wires":[["18b73548.99052b","2d744eeb.1f1592"]]},{"id":"df15f705.6356e8","type":"function","z":"29e98dcf.49cdd2","name":"Rain at 08:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 0,\n             'y': 4\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":160,"wires":[["33f56069.f0cd5"]]},{"id":"564a83e2.2ee8dc","type":"function","z":"29e98dcf.49cdd2","name":"Snow at 08:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 0,\n             'y': 3\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":200,"wires":[["33f56069.f0cd5"]]},{"id":"6d58371.7408cc8","type":"function","z":"29e98dcf.49cdd2","name":"Sun at 14:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 1,\n             'y': 7\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":300,"wires":[["33f56069.f0cd5"]]},{"id":"e2fb0047.7921f","type":"function","z":"29e98dcf.49cdd2","name":"Cloud at 14:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 1,\n             'y': 6\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":340,"wires":[["33f56069.f0cd5"]]},{"id":"d977767a.d99748","type":"function","z":"29e98dcf.49cdd2","name":"Rain at 14:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 1,\n             'y': 4\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":380,"wires":[["33f56069.f0cd5"]]},{"id":"853b3f7d.e96e2","type":"function","z":"29e98dcf.49cdd2","name":"Snow at 14:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 1,\n             'y': 3\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":420,"wires":[["33f56069.f0cd5"]]},{"id":"4cf37f41.57a81","type":"function","z":"29e98dcf.49cdd2","name":"Sun at 20:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 2,\n             'y': 7\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":520,"wires":[["33f56069.f0cd5"]]},{"id":"548e01ed.e5bfe","type":"function","z":"29e98dcf.49cdd2","name":"Cloud at 20:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 2,\n             'y': 6\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":560,"wires":[["33f56069.f0cd5"]]},{"id":"1995b804.b7ff48","type":"function","z":"29e98dcf.49cdd2","name":"Rain at 20:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 2,\n             'y': 4\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":600,"wires":[["33f56069.f0cd5"]]},{"id":"ed8d5d41.3ff6e","type":"function","z":"29e98dcf.49cdd2","name":"Snow at 20:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 2,\n             'y': 3\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":640,"wires":[["33f56069.f0cd5"]]},{"id":"ac8a10c4.5b80a","type":"function","z":"29e98dcf.49cdd2","name":"Sun at 23:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 3,\n             'y': 7\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":740,"wires":[["33f56069.f0cd5"]]},{"id":"f5c5d2b6.28068","type":"function","z":"29e98dcf.49cdd2","name":"Cloud at 23:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 3,\n             'y': 6\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":780,"wires":[["33f56069.f0cd5"]]},{"id":"af6a4dec.9bdbb","type":"function","z":"29e98dcf.49cdd2","name":"Rain at 23:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 3,\n             'y': 4\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1110,"y":820,"wires":[[]]},{"id":"cb65f723.c92408","type":"function","z":"29e98dcf.49cdd2","name":"Snow at 23:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 3,\n             'y': 3\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1120,"y":860,"wires":[["33f56069.f0cd5"]]},{"id":"33f56069.f0cd5","type":"debug","z":"29e98dcf.49cdd2","name":"x,y array debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1460,"y":380,"wires":[]},{"id":"b96e1bce.02a5f8","type":"python-function","z":"9596c410.fe1e08","name":"Switch on leds","func":"import time\nimport json\nfrom luma.led_matrix.device import max7219\nfrom luma.core.interface.serial import spi, noop\nfrom luma.core.legacy import show_message\nfrom luma.core.legacy.font import proportional, CP437_FONT\nfrom luma.core.render import canvas\nfrom luma.core.virtual import viewport\n\nserial = spi(port=0, device=0, gpio=noop())\nn = 1\nblock_orientation = 0\nrotate = 0\ninreverse = False\ndevice = max7219(serial, cascaded=n or 1, block_orientation=block_orientation,\n                     rotate=rotate or 0, blocks_arranged_in_reverse_order=inreverse)\n\ndevice.clear()\n#device.contrast(255)\n\nprint(\"Print icons=\",msg[\"icons\"])\nprint(\"Print brightness=\",msg[\"brightness\"])\n\ndevice.contrast(msg[\"brightness\"])\n\n#with canvas(device) as draw:\n#    draw.point((0, 7), fill=\"white\")\n\n#res = json.dumps(msg)\n#print(\"res=\",res)\n#newres = json.loads(res)\n#print(\"newres=\",newres)\n\nwith canvas(device) as draw:\n    for icon in msg[u\"icons\"]:\n        print (\"icon=\", icon)\n        newicon = json.loads(icon)\n        #print(\"newnicon[x]=\",newicon[\"x\"])\n        print(\"Switch on led at x=\",newicon[\"x\"],\",y=\",newicon[\"y\"])\n        draw.point((newicon[\"x\"], newicon[\"y\"]), fill=\"white\")\n\nreturn msg","outputs":1,"x":3500,"y":940,"wires":[[]]},{"id":"18b73548.99052b","type":"debug","z":"9596c410.fe1e08","name":"global push icons debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3130,"y":760,"wires":[]},{"id":"e235e4db.3a25d8","type":"simple-queue","z":"9596c410.fe1e08","name":"push icons queue","firstMessageBypass":false,"bypassInterval":"0","x":2570,"y":760,"wires":[["5dc4d062.c26c9","af6e55aa.94a1d8"]]},{"id":"e7378d3d.72b5f","type":"change","z":"9596c410.fe1e08","name":"set msg.trigger to 1","rules":[{"t":"set","p":"trigger","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2710,"y":940,"wires":[["e235e4db.3a25d8","6e7334bf.b434dc"]]},{"id":"2d744eeb.1f1592","type":"switch","z":"9596c410.fe1e08","name":"","property":"_queueCount","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2990,"y":840,"wires":[["e7378d3d.72b5f","2a9045cc.07841a"],["9a00a269.421f5","f84c9af4.d537e8"]]},{"id":"2a9045cc.07841a","type":"debug","z":"9596c410.fe1e08","name":"_queueCount > 0 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3220,"y":834,"wires":[]},{"id":"9a00a269.421f5","type":"debug","z":"9596c410.fe1e08","name":"_queueCount = 0 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3370,"y":880,"wires":[]},{"id":"6e7334bf.b434dc","type":"debug","z":"9596c410.fe1e08","name":"set msg.trigger to 1 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2950,"y":980,"wires":[]},{"id":"af6e55aa.94a1d8","type":"debug","z":"9596c410.fe1e08","name":"push icons queue debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2870,"y":660,"wires":[]},{"id":"f84c9af4.d537e8","type":"function","z":"9596c410.fe1e08","name":"global get icons","func":"var icons = global.get('icons');\nvar brightness = global.get('brightness');\n\nif(typeof brightness === 'undefined') {\n    node.warn('Variable \"brightness\" is undefined.');\n    brightness = 16;\n} else if(brightness === null){\n    node.warn('Variable \"brightness\" is null.');\n    brightness = 16;\n}\n\nvar newmsg = {\n    'icons': icons,\n    'brightness': brightness\n};\n    \nreturn newmsg;","outputs":1,"noerr":0,"x":3240,"y":940,"wires":[["b96e1bce.02a5f8","ede70582.edbd58"]]},{"id":"ede70582.edbd58","type":"debug","z":"9596c410.fe1e08","name":"global get icons debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":3500,"y":1000,"wires":[]},{"id":"840655d8.b9b1d8","type":"python-function","z":"26c5c0d8.cd22a","name":"Switch on all leds","func":"import time\nimport json\nfrom luma.led_matrix.device import max7219\nfrom luma.core.interface.serial import spi, noop\nfrom luma.core.legacy import show_message\nfrom luma.core.legacy.font import proportional, CP437_FONT\nfrom luma.core.render import canvas\nfrom luma.core.virtual import viewport\n\nserial = spi(port=0, device=0, gpio=noop())\nn = 1\nblock_orientation = 0\nrotate = 0\ninreverse = False\ndevice = max7219(serial, cascaded=n or 1, block_orientation=block_orientation,\n                     rotate=rotate or 0, blocks_arranged_in_reverse_order=inreverse)\n\ndevice.clear()\n\n#print(\"Print string=\",msg[\"icons\"])\nwith canvas(device) as draw:\n    for x in range(8):\n        for y in range(8):\n            draw.point((x, y), fill=\"white\")\n\ndevice.contrast(16)\n\n#for _ in range(5):\n#    for intensity in range(16):\n#        device.contrast(intensity * 16)\n#        time.sleep(0.1)\n        \n#device.contrast(0x80)\n#time.sleep(1)\n\n#res = json.dumps(msg)\n#print(\"res=\",res)\n#newres = json.loads(res)\n#print(\"newres=\",newres)\n            \nreturn msg","outputs":1,"x":330,"y":100,"wires":[[]]},{"id":"2a90b91.e1e3046","type":"inject","z":"26c5c0d8.cd22a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":60,"wires":[["840655d8.b9b1d8"]]},{"id":"d95f640c.71a608","type":"python-function","z":"9596c410.fe1e08","name":"Switch off leds","func":"import time\nimport json\nfrom luma.led_matrix.device import max7219\nfrom luma.core.interface.serial import spi, noop\nfrom luma.core.legacy import show_message\nfrom luma.core.legacy.font import proportional, CP437_FONT\nfrom luma.core.render import canvas\nfrom luma.core.virtual import viewport\n\nserial = spi(port=0, device=0, gpio=noop())\nn = 1\nblock_orientation = 0\nrotate = 0\ninreverse = False\ndevice = max7219(serial, cascaded=n or 1, block_orientation=block_orientation,\n                     rotate=rotate or 0, blocks_arranged_in_reverse_order=inreverse)\n\ndevice.clear()\ndevice.contrast(255)\n\nreturn msg","outputs":1,"x":240,"y":180,"wires":[["296f2284.de7aee"]]},{"id":"433f776b.a73bf8","type":"switch","z":"9596c410.fe1e08","name":"Switch by next day","property":"dt.day","propertyType":"msg","rules":[{"t":"eq","v":"dt_now.nextday","vt":"msg"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":950,"y":600,"wires":[["a26bf448.05dbe8","c869d9f8.fe2168"],[]]},{"id":"a26bf448.05dbe8","type":"switch","z":"9596c410.fe1e08","name":"Switch by 01 hour","property":"dt.hours","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1010,"y":720,"wires":[["c4d0c17.1aa574","9622accd.45216"],["17c9b8b.8ccee47"]]},{"id":"c4d0c17.1aa574","type":"debug","z":"9596c410.fe1e08","name":"next day at 01 debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1260,"y":713,"wires":[]},{"id":"c869d9f8.fe2168","type":"debug","z":"9596c410.fe1e08","name":"Switch by next day debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":760,"wires":[]},{"id":"17c9b8b.8ccee47","type":"debug","z":"9596c410.fe1e08","name":"next day not at 01 debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":760,"wires":[]},{"id":"68b13ebf.06c9","type":"function","z":"ba7d881.25dde78","name":"Group 80x: Clouds","func":"var newmsg = msg;\nmsg.icon = \"clouds\";\nreturn newmsg;","outputs":1,"noerr":0,"x":510,"y":340,"wires":[["b99320a5.e529"]]},{"id":"1481105f.8a03d","type":"function","z":"29e98dcf.49cdd2","name":"Suncloud at 08:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 0,\n             'y': 6\n             \n         },\n         {\n             'x': 0,\n             'y': 5\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1130,"y":240,"wires":[["33f56069.f0cd5"]]},{"id":"2b1e9fcf.93cf2","type":"function","z":"29e98dcf.49cdd2","name":"Suncloud at 14:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 1,\n             'y': 6\n             \n         },\n         {\n             'x': 1,\n             'y': 5\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1130,"y":460,"wires":[["33f56069.f0cd5"]]},{"id":"8953785e.aaffa8","type":"function","z":"29e98dcf.49cdd2","name":"Suncloud at 20:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 2,\n             'y': 6\n             \n         },\n         {\n             'x': 2,\n             'y': 5\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1130,"y":680,"wires":[["33f56069.f0cd5"]]},{"id":"8e1166f3.8921d8","type":"function","z":"29e98dcf.49cdd2","name":"Suncloud at 23:00","func":"var newmsg = {\n    'icons':[\n         {\n             'x': 3,\n             'y': 6\n             \n         },\n         {\n             'x': 3,\n             'y': 5\n             \n         }\n    ]\n}  \n\nreturn newmsg;","outputs":1,"noerr":0,"x":1130,"y":900,"wires":[["33f56069.f0cd5"]]},{"id":"a5512847.996898","type":"python-function","z":"26c5c0d8.cd22a","name":"Switch on cloud leds at 08","func":"import time\nimport json\nfrom luma.led_matrix.device import max7219\nfrom luma.core.interface.serial import spi, noop\nfrom luma.core.legacy import show_message\nfrom luma.core.legacy.font import proportional, CP437_FONT\nfrom luma.core.render import canvas\nfrom luma.core.virtual import viewport\n\nserial = spi(port=0, device=0, gpio=noop())\nn = 1\nblock_orientation = 0\nrotate = 0\ninreverse = False\ndevice = max7219(serial, cascaded=n or 1, block_orientation=block_orientation,\n                     rotate=rotate or 0, blocks_arranged_in_reverse_order=inreverse)\n\ndevice.clear()\n\n#print(\"Print string=\",msg[\"icons\"])\nwith canvas(device) as draw:\n    draw.point((0, 6), fill=\"white\")\n\ndevice.contrast(255)\n\n#for _ in range(5):\n#    for intensity in range(16):\n#        device.contrast(intensity * 16)\n#        time.sleep(0.1)\n        \n#device.contrast(0x80)\n#time.sleep(1)\n\n#res = json.dumps(msg)\n#print(\"res=\",res)\n#newres = json.loads(res)\n#print(\"newres=\",newres)\n            \nreturn msg","outputs":1,"x":360,"y":160,"wires":[[]]},{"id":"5dc5f423.6040ec","type":"sun events","z":"fd9e96f3.fb83a8","testmode":false,"verbose":true,"topic":"sunrise and sunset in Milan","name":"sunrise and sunset in Milan","x":170,"y":80,"wires":[["24b146e9.0fde5a","1a2c234b.4ae58d"]]},{"id":"24b146e9.0fde5a","type":"switch","z":"fd9e96f3.fb83a8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"sunrise","vt":"str"},{"t":"eq","v":"sunset","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":140,"wires":[["b76aba3d.09d068"],["c8cbd44.c78be28"]]},{"id":"b76aba3d.09d068","type":"change","z":"fd9e96f3.fb83a8","name":"set light to max","rules":[{"t":"set","p":"brightness","pt":"global","to":"255","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":100,"wires":[["78ec6d0.65d5b94"]]},{"id":"c8cbd44.c78be28","type":"change","z":"fd9e96f3.fb83a8","name":"set light to min","rules":[{"t":"set","p":"brightness","pt":"global","to":"16","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":180,"wires":[["66431d25.12c404"]]},{"id":"78ec6d0.65d5b94","type":"debug","z":"fd9e96f3.fb83a8","name":"set light to max debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":720,"y":100,"wires":[]},{"id":"66431d25.12c404","type":"debug","z":"fd9e96f3.fb83a8","name":"set light to min debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":720,"y":180,"wires":[]},{"id":"8b620f78.fe4f1","type":"switch","z":"9596c410.fe1e08","name":"Switch by 8, 14 and 20 hour","property":"dt.hours","propertyType":"msg","rules":[{"t":"eq","v":"10","vt":"num"},{"t":"eq","v":"16","vt":"str"},{"t":"eq","v":"22","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1320,"y":513,"wires":[["2e16dd62.552472","4cb6bd16.8483a4"],["fdd00fcd.c9364","4cb6bd16.8483a4"],["dbc37810.2fc348","4cb6bd16.8483a4"]]},{"id":"4cb6bd16.8483a4","type":"debug","z":"9596c410.fe1e08","name":"Switch by 8, 14 and 20 hour debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1660,"y":400,"wires":[]},{"id":"43b8e2a5.a95a3c","type":"subflow:fd9e96f3.fb83a8","z":"9596c410.fe1e08","name":"","env":[],"x":200,"y":40,"wires":[["1f4c4ef6.9e66a1"]]},{"id":"1f4c4ef6.9e66a1","type":"debug","z":"9596c410.fe1e08","name":"Global light based on sunrise and sunset debug","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","targetType":"full","x":620,"y":40,"wires":[]},{"id":"1a2c234b.4ae58d","type":"debug","z":"fd9e96f3.fb83a8","name":"sunrise and sunset in Milan debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":480,"y":40,"wires":[]}]